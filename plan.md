# 팩션 체스(Faction Chess) IGD 목표/설계 문서

## 0. 목표 (한 문장)
체스-유사 격자 게임을 “설계변수 \(x\)”로 정의하고, self-play 결과 통계로 **밸런스가 맞는 규칙/팩션/맵(장애물 포함)**을 자동 탐색한다.

## 1. 게임 정의 (우리가 만드는 “체스”)
### 1.1 보드
- 맵 크기: `width` x `height` (가변)
- 장애물: 이동/점프의 착지 및 슬라이딩 경로를 막는 **정적 블록 타일** (가변)

### 1.2 팩션
- 2개 이상 팩션 지원(기본 2, 확장 3)
- 팩션마다 “말 종류(타입)”의 스펙이 다를 수 있음

### 1.3 말(유닛) 타입
팩션마다 아래를 “타입별”로 가짐(최소: `unit0~unit4` + `king`).
- **개수**: 타입별 말 수(가변)
- **행마 규칙**: 이동 패턴 ID(가변)
- **이동 거리/점프 횟수**: `move` (가변)
- **공격 사거리**: `range` (가변)
- **공격력/체력**: `damage`, `hp` (가변)

### 1.4 승패
- `king`이 잡히면 즉시 패배(체스의 왕과 동일한 역할)
- 최대 턴(`max_steps`) 초과 시 무승부 또는 남은 전력으로 판정(퇴화 방지 규칙 필요)

## 2. 설계변수 \(x\) (우리가 “자유롭게 설계”하는 것)
### 2.1 맵 설계
- `width`, `height`
- 장애물 파라미터(최소 구성)
  - `obstacle_density` (0..): 장애물 밀도
  - `obstacle_pattern` (정수 ID): 장애물 배치 템플릿(대칭/중앙/랜덤 등)

### 2.2 팩션/말 설계
팩션 `p0`, `p1`, ... 에 대해:
- `p{f}_unit{i}_units`
- `p{f}_unit{i}_pattern`
- `p{f}_unit{i}_move`
- `p{f}_unit{i}_range`
- `p{f}_unit{i}_damage`
- `p{f}_unit{i}_hp`
- `king`은 1개 고정(개수는 고정) + 스펙은 필요시 설계변수로 둘 수 있음

## 3. 평가 \(y(x)\) (플레이 결과로 관측하는 값)
- 승률(2팩션: `p0_win_rate`, 다팩션: `win_matrix`)
- 무승부율(`draw_rate`)
- 교전 거리 분포(`distance_samples`, `avg_distance`)
- 블로우아웃(0.05 미만/0.95 초과 승률) 카운트

## 4. 목표함수 \(L(y)\) (밸런스 정의)
최소 목표:
- 모든 대전 쌍 승률이 0.5에 가깝다
- 블로우아웃이 적다
- 무승부/무교전 퇴화를 강하게 억제한다
- (선택) 교전 거리 분포가 목표를 따른다

## 5. 최적화 루프 (IGD 구조)
### 5.1 Outer loop: 설계 최적화(black-box)
- ES(대칭 샘플링 + 공통 난수)로 설계변수 \(x\)를 업데이트
- “맵/장애물/행마/개수”는 이산값이 많으므로 **클램프/정수화 규칙이 필수**

### 5.2 Inner loop: 플레이 학습/평가
- 주어진 \(x\)로 환경 생성
- self-play로 정책 학습
- 평가 에피소드로 \(y(x)\) 수집

### 5.3 LB(라플라스) 정규화(선택)
- 설계공간에서 승률 지형이 지나치게 뾰족해지는 것을 억제하기 위해,
  동일 seed(CRN)에서의 **center/pos/neg** 평가로 라플라시안을 근사하고,
  곡률이 큰 방향의 ES 업데이트를 약화시켜 “튼튼한 밸런스”를 선호한다.

  - 근사:
    \[
    \Delta P(x) \approx \frac{P(x+\sigma e)+P(x-\sigma e)-2P(x)}{\sigma^2\|e\|^2}
    \]
  - 사용 방식(구현):
    \(\Delta P(x)\)가 큰 샘플은 그 방향 업데이트 가중치를 낮춘다.

## 6. 구현 마일스톤(바로 시작)
- M0: 이 문서 고정
- M1: `GridCombatEnv`에 장애물(생성/저장/충돌) 구현
- M2: `DesignOptimizer`에 `obstacle_density`, `obstacle_pattern`을 설계변수로 추가 + 클램프 규칙 추가
- M3: `main.py`를 “IGD 실행 엔트리”로 정리(최소 실행 루프)
- M4: 최소 회귀 테스트 추가(장애물 생성이 스폰 영역을 침범하지 않는지 등)

## 7. 코드 변경 원칙
- DRY / KISS / 단일 책임
- 불필요한 이름 변경 금지
- 새 파일은 필요할 때만(그리고 이미 있는 파일을 우선 사용)

